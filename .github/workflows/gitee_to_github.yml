name: åŒæ­¥ gitee ä»“åº“ä»£ç åˆ° Github ä»“åº“

on:
  # push:
  #   branches: [ "main" ]
  schedule:
    - cron: '0 0 * * 1'
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  sync-gitee:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Github Repo
        uses: actions/checkout@v2
        with:
          submodules: false  # ç¦ç”¨å­æ¨¡å—å…‹éš†
          
      - name: Set up Git
        run: |
          git config --global user.name "darkersu"
          git config --global user.email "sxp_developer@163.com"
      - name: clone gitee repo
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          echo :ğŸ“¥ æ­£åœ¨å…‹éš† Gitee ä»“åº“çš„ ${GITEE_BRANCH} åˆ†æ”¯...
          git clone -b master https://oauth2:${{ secrets.GITEE_TOKEN }}@gitee.com/meetjs/vant4-kit.git temp
          echo "ğŸ” è·å–æäº¤ä¿¡æ¯..."
          LAST_SYNC_COMMIT=$(git log --grep="Sync from Gitee" -1 --format="%B" | grep -oP "Gitee Commit: \K[a-f0-9]+") || true
          
          cd temp
          GITEE_LATEST_COMMIT=$(git rev-parse HEAD)
          echo $GITEE_LATEST_COMMIT
          cd ..
          
          echo "ğŸ“‹ å‡†å¤‡å·¥ä½œç›®å½•..."
          WORK_DIR="sync_workspace"
          rm -rf $WORK_DIR
          mkdir -p $WORK_DIR
          echo "ğŸ“‹ å¤åˆ¶æ–‡ä»¶åˆ°å·¥ä½œç›®å½•..."
          cd temp
          shopt -s extglob
          cp -r !(*.git|.github) "../$WORK_DIR/"
          cd ..
          rm -rf temp
          
          echo "ğŸ”„ å‡†å¤‡æ¨é€ä»£ç ..."
          cd $WORK_DIR
         
          # åˆå§‹åŒ– git
          git init
          echo "ğŸ”„ å¼€å§‹å‡†å¤‡æ¨é€ä»£ç åˆ° GitHub..."
          git add .
          echo "âœ… å·²æ·»åŠ æ‰€æœ‰æ–‡ä»¶åˆ°æš‚å­˜åŒº"
          git commit -m "Sync from Gitee $(date '+%Y-%m-%d %H:%M:%S')
            Gitee Commit: ${GITEE_LATEST_COMMIT}"
          echo "âœ… å·²åˆ›å»ºæäº¤è®°å½•"
          # æ¨é€åˆ° GitHub
          echo "ğŸ”— æ­£åœ¨é…ç½® GitHub è¿œç¨‹ä»“åº“åœ°å€..."
          git remote add origin https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/mitjs/vant4-kit.git
          echo "âœ… è¿œç¨‹ä»“åº“é…ç½®å®Œæˆ"
          echo "ğŸŒ¿ æ­£åœ¨åˆ‡æ¢åˆ° master åˆ†æ”¯..."
          git branch -M master
          echo "âœ… åˆ†æ”¯åˆ‡æ¢å®Œæˆ"
          echo "â¬†ï¸ æ­£åœ¨æ¨é€ä»£ç åˆ° GitHub..."
          git push -f origin master
          echo "ğŸ‰ ä»£ç æ¨é€å®Œæˆï¼"
          
          cd ..
          rm -rf $WORK_DIR 
